<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Lookup - Missive Sidebar</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); padding: 15px; min-height: 100vh; }
        .container { max-width: 100%; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        .header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0; }
        .header h1 { font-size: 18px; color: #128C7E; margin: 0 0 5px; }
        .header .subtitle { font-size: 12px; color: #666; }
        .status { padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; text-align: center; font-weight: 500; }
        .status.loading { background: #E3F2FD; color: #1976D2; }
        .status.success { background: #E8F5E9; color: #2E7D32; }
        .status.error { background: #FFEBEE; color: #C62828; }
        .contact-card { background: #F5F5F5; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #25D366; }
        .contact-field { margin-bottom: 10px; }
        .contact-field:last-child { margin-bottom: 0; }
        .contact-field label { display: block; font-weight: 600; color: #555; font-size: 11px; text-transform: uppercase; margin-bottom: 4px; }
        .contact-field .value { color: #222; font-size: 14px; font-weight: 500; word-break: break-word; }
        .whatsapp-btn { display: block; width: 100%; padding: 16px; background: linear-gradient(135deg, #25D366 0%, #20BA5A 100%); color: white; text-align: center; text-decoration: none; border-radius: 10px; font-weight: 700; font-size: 15px; margin: 15px 0; transition: all 0.3s; box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3); }
        .whatsapp-btn:hover { background: linear-gradient(135deg, #20BA5A 0%, #128C7E 100%); transform: translateY(-2px); }
        .whatsapp-btn.disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
        .section { margin-top: 25px; }
        .section-title { font-size: 14px; font-weight: 700; color: #128C7E; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
        .section-title .badge { background: #128C7E; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; }
        .doc-list { max-height: 350px; overflow-y: auto; }
        .doc-item { background: white; border: 1px solid #E0E0E0; padding: 12px; border-radius: 8px; margin-bottom: 10px; transition: all 0.2s; cursor: pointer; }
        .doc-item:hover { border-color: #25D366; box-shadow: 0 2px 8px rgba(37, 211, 102, 0.2); transform: translateX(4px); }
        .doc-item .filename { font-weight: 600; color: #222; font-size: 13px; margin-bottom: 6px; word-break: break-word; }
        .doc-item .meta { font-size: 11px; color: #666; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #F5F5F5; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #25D366; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± WhatsApp Lookup</h1>
            <div class="subtitle">Last 7 days via Periskope API</div>
        </div>
        <div id="status" class="status loading">üîÑ Initializing...</div>
        <div id="content" style="display:none;">
            <div class="contact-card">
                <div class="contact-field"><label>Contact Name</label><div class="value" id="contact-name">-</div></div>
                <div class="contact-field"><label>Email Address</label><div class="value" id="contact-email">-</div></div>
                <div class="contact-field"><label>WhatsApp Number</label><div class="value" id="contact-phone">-</div></div>
            </div>
            <a id="whatsapp-link" href="#" class="whatsapp-btn disabled" target="_blank">üí¨ Open WhatsApp Chat</a>
            <div class="section">
                <div class="section-title"><span>üìÑ Documents Exchanged</span><span class="badge" id="doc-count">0</span></div>
                <div id="doc-list" class="doc-list"></div>
            </div>
        </div>
    </div>
    <script>
        const PERISKOPE_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCIgOiAiMDE4ODhmODMtMzAzZS00MzI0LWJiMDctNDY2OThhZDdjMDI4IiwgInJvbGUiIDogImFwaSIsICJ0eXBlIiA6ICJhcGkiLCAibmFtZSIgOiAiT00gUnViZSIsICJleHAiIDogMjA4NTc0MDk5MywgImlhdCIgOiAxNzcwMjA4MTkzLCAic3ViIiA6ICI0ZmQ1YzY1My1iMzI2LTQ3MWItOWE0My1iZjU3ZjczZTk3YjEiLCAiaXNzIiA6ICJwZXJpc2tvcGUuYXBwIiwgIm1ldGFkYXRhIiA6IHsic2NvcGVzIjogWyI5MTkzNDQ4MDc3NzdAYy51cyJdfX0.t82KxFbfQY5jYnz4_b43t7hX1DDGRhVRDUTEm9sjoF8";
        const PERISKOPE_PHONE = "919344807777@c.us";
        const PERISKOPE_API = "https://api.periskope.app";
        const COMPOSIO_API_KEY = "PASTE_YOUR_COMPOSIO_API_KEY_HERE";

        // Parse Missive variables from URL
        const params = new URLSearchParams(window.location.search);

        // Support multiple Missive variable formats
        const recipientFirstName = params.get('recipient_first_name') || params.get('recipient.first_name') || params.get('first_name') || '';
        const recipientLastName = params.get('recipient_last_name') || params.get('recipient.last_name') || params.get('last_name') || '';
        const recipientName = params.get('recipient_name') || params.get('recipient.name') || params.get('name') || '';
        const recipientEmail = params.get('recipient_email') || params.get('recipient.email') || params.get('email') || '';
        const recipientPhone = params.get('recipient_phone_number') || params.get('recipient.phone_number') || params.get('phone') || '';

        // Fallback to message.from_* variables
        const senderFirstName = params.get('message_from_first_name') || params.get('message.from_first_name') || '';
        const senderLastName = params.get('message_from_last_name') || params.get('message.from_last_name') || '';
        const senderName = params.get('message_from_name') || params.get('message.from_name') || '';
        const senderEmail = params.get('message_from_email') || params.get('message.from_email') || '';

        // Determine final values
        const finalFirstName = recipientFirstName || senderFirstName;
        const finalLastName = recipientLastName || senderLastName;
        const finalName = recipientName || senderName || `${finalFirstName} ${finalLastName}`.trim();
        const finalEmail = recipientEmail || senderEmail;
        const finalPhone = recipientPhone;

        const statusEl = document.getElementById('status');
        const contentEl = document.getElementById('content');
        const whatsappBtn = document.getElementById('whatsapp-link');

        async function searchGmailContacts(query) {
            try {
                const response = await fetch('https://backend.composio.dev/api/v1/actions/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': COMPOSIO_API_KEY
                    },
                    body: JSON.stringify({
                        actions: [{
                            action: 'GMAIL_SEARCH_PEOPLE',
                            params: {
                                query: query,
                                person_fields: 'names,emailAddresses,phoneNumbers',
                                other_contacts: true,
                                pageSize: 10
                            }
                        }]
                    })
                });

                if (!response.ok) return null;
                const data = await response.json();
                const results = data?.data?.results || [];
                if (results.length > 0) {
                    const person = results[0]?.person;
                    const phoneNumbers = person?.phoneNumbers || [];
                    if (phoneNumbers.length > 0) {
                        return phoneNumbers[0].value;
                    }
                }
                return null;
            } catch (error) {
                console.error('Gmail search error:', error);
                return null;
            }
        }

        async function loadWhatsAppData() {
            if (!finalName && !finalEmail && !finalPhone) {
                statusEl.className = 'status error';
                statusEl.textContent = '‚ö†Ô∏è No sender information provided';
                return;
            }

            // Display sender info
            document.getElementById('contact-name').textContent = finalName || 'Unknown';
            document.getElementById('contact-email').textContent = finalEmail || 'Not provided';
            contentEl.style.display = 'block';

            // Step 1: Get phone number
            let phoneNumber = finalPhone;

            if (!phoneNumber) {
                statusEl.textContent = 'üîç Looking up phone number in contacts...';

                // Search by email first, then by name
                const searchQuery = finalEmail || finalName;
                if (searchQuery) {
                    phoneNumber = await searchGmailContacts(searchQuery);
                }
            }

            if (!phoneNumber) {
                statusEl.className = 'status error';
                statusEl.textContent = '‚ùå No phone number found in contacts';
                document.getElementById('contact-phone').textContent = 'Not found in contacts';
                document.getElementById('doc-list').innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><div>Phone number required for WhatsApp lookup</div></div>';
                return;
            }

            // Normalize phone number
            const normalizedPhone = phoneNumber.replace(/\D/g, '');
            document.getElementById('contact-phone').textContent = phoneNumber;
            whatsappBtn.href = `https://wa.me/${normalizedPhone}`;
            whatsappBtn.classList.remove('disabled');

            // Step 2: Fetch WhatsApp chats from Periskope
            statusEl.textContent = 'üì± Fetching WhatsApp chats from Periskope...';

            try {
                const chatsResponse = await fetch(`${PERISKOPE_API}/chats`, {
                    headers: {
                        'Authorization': `Bearer ${PERISKOPE_TOKEN}`,
                        'x-phone': PERISKOPE_PHONE,
                        'Content-Type': 'application/json'
                    }
                });

                if (!chatsResponse.ok) {
                    throw new Error(`Chats API failed: ${chatsResponse.status}`);
                }

                const chatsData = await chatsResponse.json();

                // Find chat matching phone or name
                const chat = chatsData.chats?.find(c => {
                    const chatPhone = c.phone?.replace(/\D/g, '') || '';
                    const chatName = c.name?.toLowerCase() || '';
                    const searchName = finalName.toLowerCase();

                    return chatPhone.includes(normalizedPhone.slice(-10)) || 
                           normalizedPhone.includes(chatPhone.slice(-10)) ||
                           (searchName && chatName.includes(searchName));
                });

                if (!chat) {
                    statusEl.className = 'status error';
                    statusEl.textContent = '‚ùå No WhatsApp chat found for this contact';
                    document.getElementById('doc-list').innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><div>No WhatsApp chat history found</div></div>';
                    return;
                }

                // Step 3: Fetch messages from last 7 days
                statusEl.textContent = 'üì• Loading messages from last week...';
                const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();

                const messagesResponse = await fetch(`${PERISKOPE_API}/chats/${chat.id}/messages?since=${oneWeekAgo}`, {
                    headers: {
                        'Authorization': `Bearer ${PERISKOPE_TOKEN}`,
                        'x-phone': PERISKOPE_PHONE
                    }
                });

                if (!messagesResponse.ok) {
                    throw new Error(`Messages API failed: ${messagesResponse.status}`);
                }

                const messagesData = await messagesResponse.json();

                // Extract documents from messages
                const documents = [];
                (messagesData.messages || []).forEach(msg => {
                    const media = msg.media || msg.document || msg.image || msg.video || msg.audio;
                    if (media) {
                        documents.push({
                            filename: media.filename || media.caption || 'Unnamed file',
                            type: media.mimetype || msg.type || 'document',
                            timestamp: msg.timestamp || msg.createdAt,
                            sender: msg.sender?.name || msg.from || 'Unknown'
                        });
                    }
                });

                // Display results
                statusEl.className = 'status success';
                statusEl.textContent = `‚úÖ Found ${documents.length} documents from last 7 days`;
                document.getElementById('doc-count').textContent = documents.length;

                const docListEl = document.getElementById('doc-list');
                if (documents.length === 0) {
                    docListEl.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><div>No documents exchanged in the last 7 days</div></div>';
                } else {
                    docListEl.innerHTML = documents.map(doc => `
                        <div class="doc-item">
                            <div class="filename">üìÑ ${doc.filename}</div>
                            <div class="meta">
                                <span><strong>Type:</strong> ${doc.type}</span>
                                <span><strong>From:</strong> ${doc.sender}</span>
                            </div>
                            <div class="meta" style="margin-top: 4px;">
                                <span><strong>Date:</strong> ${new Date(doc.timestamp).toLocaleDateString()}</span>
                            </div>
                        </div>
                    `).join('');
                }

            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '‚ùå Error: ' + error.message;
                console.error('Error:', error);
                document.getElementById('doc-list').innerHTML = '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><div>Failed to load WhatsApp data</div></div>';
            }
        }

        // Load data when page loads
        window.addEventListener('DOMContentLoaded', loadWhatsAppData);
    </script>
</body>
</html>